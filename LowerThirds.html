<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">

<style>

body{
  margin:0;
  overflow:hidden;
  background:transparent;
  font-family:Arial,Helvetica,sans-serif;
}

#container{
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:220px;
  overflow:hidden;
}

/* ===== TEXT WRAPPER ===== */

#text-wrapper{
  position:absolute;
  width:100%;
  height:100%;
}

/* ===== ANIMATION ===== */

.slide-in{
  animation:slideIn .6s ease forwards;
}

.slide-out{
  animation:slideOut .6s ease forwards;
}

@keyframes slideIn{
  from{
    transform:translateX(-100%);
    opacity:0;
  }
  to{
    transform:translateX(0);
    opacity:1;
  }
}

@keyframes slideOut{
  from{
    transform:translateX(0);
    opacity:1;
  }
  to{
    transform:translateX(-100%);
    opacity:0;
  }
}

/* ===== TEXT ===== */

#headline{
  font-size:48px;
  font-weight:bold;
  color:white;
}

#subline{
  font-size:28px;
  color:white;
}

</style>
</head>

<body>

<div id="container">
  <div id="text-wrapper">
      <div id="headline"></div>
      <div id="subline"></div>
  </div>
</div>

<script>

/**************** CONFIG ****************/

const ENDPOINT =
"https://script.google.com/macros/s/AKfycbyz-izL1cT1FGGIXDStm32Fxw_bGfmV_bxrS29J2tlGaUdJytmlZbVDWmlevQJmGI5D/exec";

const HOLD_DURATION = 6000;
const ANIMATION_DURATION = 600;

let slides=[];
let currentIndex=-1;

/**************** PLAY SLIDE ****************/

function playSlide(item){

  const wrapper =
    document.getElementById("text-wrapper");

  document.getElementById("headline")
    .textContent = item.headline || "";

  document.getElementById("subline")
    .textContent = item.subline || "";

  wrapper.className="";
  wrapper.classList.add("slide-in");

  setTimeout(()=>{
    wrapper.classList.remove("slide-in");
    wrapper.classList.add("slide-out");
  },HOLD_DURATION);
}

/**************** TIMELINE SYNC ****************/

async function syncTimeline(){

  try{

    const res = await fetch(
      ENDPOINT + "?t=" + Date.now()
    );

    const data = await res.json();

    slides = data.lowerThird || [];

    if(!slides.length){
      console.warn("No slides yet");
      return;
    }

    const timelineIndex =
      Number(data.timelineIndex);

    if(isNaN(timelineIndex)){
      console.warn("timelineIndex missing");
      return;
    }

    const index =
      timelineIndex % slides.length;

    if(index === currentIndex)
      return;

    const item = slides[index];

    if(!item){
      console.warn("Invalid slide");
      return;
    }

    currentIndex=index;

    playSlide(item);

    /* sync promo screen */
    localStorage.setItem(
      "currentPromo",
      JSON.stringify(item)
    );

  }
  catch(err){
    console.error("Sync failed",err);
  }
}

/**************** START ****************/

syncTimeline();

/* check every second */
setInterval(syncTimeline,1000);

</script>

</body>
</html>
