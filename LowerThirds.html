<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">

<link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;700&display=swap" rel="stylesheet">

<style>

body{
  margin:0;
  overflow:hidden;
  background:transparent;
  font-family:'Google Sans',Arial,Helvetica,sans-serif;
}

#banner{
  position:absolute;
  top:0;
  width:100%;
  height:220px;
  overflow:hidden;
}

#content{
  position:absolute;
  top:40px;
  left:80px;
}

#text-wrapper{
  margin-left:300px;
  color:white;
}

#headline{
  font-size:50px;
  font-weight:700;
}

#subline{
  font-size:36px;
  margin-top:6px;
}

/* ===== ANIMATION ===== */

.slide-in{
  animation:slideIn .6s ease forwards;
}

.slide-out{
  animation:slideOut .6s ease forwards;
}

@keyframes slideIn{
  from{transform:translateX(-100%);opacity:0;}
  to{transform:translateX(0);opacity:1;}
}

@keyframes slideOut{
  from{transform:translateX(0);opacity:1;}
  to{transform:translateX(-100%);opacity:0;}
}

</style>
</head>

<body>

<div id="banner">
  <div id="content">
    <div id="text-wrapper">
      <div id="headline"></div>
      <div id="subline"></div>
    </div>
  </div>
</div>

<script>

/******** CONFIG ********/

const ENDPOINT =
"https://script.google.com/macros/s/AKfycbyz-izL1cT1FGGIXDStm32Fxw_bGfmV_bxrS29J2tlGaUdJytmlZbVDWmlevQJmGI5D/exec";

const HOLD_DURATION = 6000;
const ANIMATION_DURATION = 600;

/******** STATE ********/

let slides = [];
let currentIndex = -1;
let animating = false;

/******** PLAY SLIDE ********/

function playSlide(item){

  if(animating) return;
  animating = true;

  const wrapper =
    document.getElementById("text-wrapper");

  document.getElementById("headline").textContent =
    item.headline || "";

  document.getElementById("subline").textContent =
    item.subline || "";

  /* ðŸ”— PROMO SCREEN SYNC */
  localStorage.setItem(
    "currentPromo",
    JSON.stringify(item)
  );

  wrapper.className="";
  wrapper.classList.add("slide-in");

  setTimeout(()=>{
    wrapper.classList.remove("slide-in");
    wrapper.classList.add("slide-out");
  },HOLD_DURATION);

  setTimeout(()=>{
    wrapper.classList.remove("slide-out");
    animating=false;
  },HOLD_DURATION + ANIMATION_DURATION);
}

/******** FOLLOW SERVER TIMELINE ********/

async function syncTimeline(){

  try{

    const res =
      await fetch(ENDPOINT + "?t=" + Date.now());

    const data = await res.json();

    if(!data.lowerThird?.length) return;

    slides = data.lowerThird;

    const serverIndex =
      data.timelineIndex % slides.length;

    /* ONLY CHANGE WHEN SERVER CHANGES */
    if(serverIndex !== currentIndex){
      currentIndex = serverIndex;
      playSlide(slides[currentIndex]);
    }

  }catch(e){
    console.log("sync retry");
  }
}

/******** START ********/

syncTimeline();
setInterval(syncTimeline,2000);

</script>

</body>
</html>
