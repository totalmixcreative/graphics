<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">

<style>

body{
  margin:0;
  overflow:hidden;
  background:transparent;
  font-family:Arial,Helvetica,sans-serif;
}

#container{
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:220px;
  overflow:hidden;
}

/* ===== TEXT WRAPPER ===== */

#text-wrapper{
  position:absolute;
  width:100%;
  height:100%;
}

/* ===== ANIMATION ===== */

.slide-in{
  animation:slideIn .6s ease forwards;
}

.slide-out{
  animation:slideOut .6s ease forwards;
}

@keyframes slideIn{
  from{
    transform:translateX(-100%);
    opacity:0;
  }
  to{
    transform:translateX(0);
    opacity:1;
  }
}

@keyframes slideOut{
  from{
    transform:translateX(0);
    opacity:1;
  }
  to{
    transform:translateX(-100%);
    opacity:0;
  }
}

/* ===== TEXT ===== */

#headline{
  font-size:48px;
  font-weight:bold;
  color:white;
}

#subline{
  font-size:28px;
  color:white;
}

</style>
</head>

<body>

<div id="container">
  <div id="text-wrapper">
      <div id="headline"></div>
      <div id="subline"></div>
  </div>
</div>

<script>

/**************** CONFIG ****************/

const ENDPOINT =
"https://script.google.com/macros/s/AKfycbyz-izL1cT1FGGIXDStm32Fxw_bGfmV_bxrS29J2tlGaUdJytmlZbVDWmlevQJmGI5D/exec";

const HOLD_DURATION = 6000;
const TOTAL_DURATION = HOLD_DURATION + 600;

let slides=[];
let currentIndex=0;

/******** PLAY ********/

function playSlide(item){

  const wrapper =
    document.getElementById("text-wrapper");

  document.getElementById("headline").textContent =
    item.headline || "";

  document.getElementById("subline").textContent =
    item.subline || "";

  wrapper.className="";
  wrapper.classList.add("slide-in");

  setTimeout(()=>{
    wrapper.classList.remove("slide-in");
    wrapper.classList.add("slide-out");
  },HOLD_DURATION);

}

/******** ROTATION LOOP ********/

function startRotation(){

  setInterval(()=>{

    if(!slides.length) return;

    currentIndex =
      (currentIndex + 1) % slides.length;

    const item = slides[currentIndex];

    playSlide(item);

    localStorage.setItem(
      "currentPromo",
      JSON.stringify(item)
    );

  },TOTAL_DURATION);

}

/******** SYNC WITH ENDPOINT ********/

async function syncTimeline(){

  try{

    const res =
      await fetch(ENDPOINT+"?t="+Date.now());

    const data=await res.json();

    if(!data.lowerThird?.length) return;

    slides=data.lowerThird;

    const timelineIndex =
      Number(data.timelineIndex);

    if(!isNaN(timelineIndex)){
      currentIndex =
        timelineIndex % slides.length;
    }

  }catch(e){
    console.log("sync retry");
  }
}

/******** START ********/

async function init(){

  /* 1️⃣ LOAD DATA FIRST */
  await loadData();

  /* safety check */
  if(!slides || slides.length === 0){
    console.log("No slides yet...");
    setTimeout(init,2000);
    return;
  }

  /* 2️⃣ sync global timeline */
  await syncTimeline();

  /* 3️⃣ play correct slide */
  playSlide(slides[currentIndex]);

  /* 4️⃣ start rotation */
  startRotation();

  /* 5️⃣ periodic updates */
  setInterval(loadData,120000);
  setInterval(syncTimeline,30000);
}

async function loadData(){

  try{

    const response = await fetch(API_URL + "?t=" + Date.now());
    const data = await response.json();

    if(!data || !data.lowerThird) return;

    slides = data.lowerThird;

  }catch(err){
    console.log("Load failed",err);
  }

}
  
init();

</script>

</body>
</html>




