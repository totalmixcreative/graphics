<script>

/******** CONFIG ********/

const ENDPOINT_URL =
"https://script.google.com/macros/s/AKfycbyz-izL1cT1FGGIXDStm32Fxw_bGfmV_bxrS29J2tlGaUdJytmlZbVDWmlevQJmGI5D/exec";

const HOLD_DURATION = 6000;
const ANIMATION_DURATION = 600;

/******** STATE ********/

let items = [];
let currentIndex = -1;
let animating = false;

/******** LOAD DATA ********/

async function loadData(){

  try{

    const res =
      await fetch(ENDPOINT_URL+"?t="+Date.now());

    const data = await res.json();

    if(!data.lowerThird?.length) return;

    items = data.lowerThird;

    const serverIndex =
      data.timelineIndex % items.length;

    followTimeline(serverIndex);

  }catch(e){
    console.log("endpoint retry");
  }
}

/******** TIMELINE FOLLOWER ********/

function followTimeline(targetIndex){

  if(targetIndex === currentIndex) return;
  if(animating) return;

  currentIndex = targetIndex;

  playSlide(items[currentIndex]);
}

/******** PLAY SLIDE ********/

function playSlide(item){

  const wrapper =
    document.getElementById("text-wrapper");

  animating = true;

  headline.textContent =
    item.headline || "";

  subline.textContent =
    item.subline || "";

  /* PROMO SYNC */
  localStorage.setItem(
    "currentPromo",
    JSON.stringify(item)
  );

  wrapper.className="";
  wrapper.classList.add("slide-in");

  setTimeout(()=>{
    wrapper.classList.remove("slide-in");
    wrapper.classList.add("slide-out");
  },HOLD_DURATION);

  setTimeout(()=>{
    wrapper.classList.remove("slide-out");
    animating=false;
  },HOLD_DURATION + ANIMATION_DURATION);
}

/******** POLL MASTER CLOCK ********/

loadData();

/* check server regularly */
setInterval(loadData,2000);

</script>
