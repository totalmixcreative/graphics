<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Carbon Lower Third</title>

<link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;700&display=swap" rel="stylesheet">

<style>

body{
  margin:0;
  overflow:hidden;
  background:transparent;
  font-family:'Google Sans',Arial,Helvetica,sans-serif;
}

#banner{
  position:absolute;
  top:0;
  width:100%;
  height:220px;
  overflow:hidden;
}

/* BACKGROUND VIDEO */

#bgVideo{
  position:absolute;
  width:100%;
  height:100%;
  object-fit:cover;
  z-index:1;
}

/* CONTENT */

#content{
  position:absolute;
  top:40px;
  left:80px;
}

#text-wrapper{
  position:relative;
  z-index:2;
  color:white;
  margin-left:300px;
}

#headline{
  font-size:50px;
  font-weight:700;
  margin:0;
}

#subline{
  font-size:36px;
  margin-top:6px;
}

#whatsOn{
  position:absolute;
  left:-60px;
  top:-15px;
  z-index:3;
  height:100px;
}

/* ANIMATION */

.slide-in{
  animation:slideIn .6s ease forwards;
}

.slide-out{
  animation:slideOut .6s ease forwards;
}

@keyframes slideIn{
  from{transform:translateX(-100%);opacity:0;}
  to{transform:translateX(0);opacity:1;}
}

@keyframes slideOut{
  from{transform:translateX(0);opacity:1;}
  to{transform:translateX(-100%);opacity:0;}
}

</style>
</head>

<body>

<div id="banner">

<video id="bgVideo" autoplay muted loop playsinline>
<source src="https://totalmixcreative.github.io/graphics/carbon%20bottom.mp4">
</video>

<div id="content">

<div id="text-wrapper">
<div id="headline"></div>
<div id="subline"></div>
</div>

<img id="whatsOn"
src="https://totalmixcreative.github.io/graphics/whatson.png">

</div>
</div>

<script>

/**************** CONFIG ****************/

const ENDPOINT_URL =
"https://script.google.com/macros/s/AKfycbyz-izL1cT1FGGIXDStm32Fxw_bGfmV_bxrS29J2tlGaUdJytmlZbVDWmlevQJmGI5D/exec";

const HOLD_DURATION = 6000;
const ANIMATION_DURATION = 600;
const TOTAL_DURATION = HOLD_DURATION + ANIMATION_DURATION;

/**************** STATE ****************/

let items=[];
let nextItems=[];
let index=0;
let animating=false;
let serverIndex = 0;
let pendingIndex = null;

/**************** LOAD DATA ****************/

async function loadData(){

  try{

    const res =
      await fetch(ENDPOINT_URL+"?t="+Date.now());

    const data = await res.json();

    nextItems = data.lowerThird || [];

if(typeof data.timelineIndex !== "undefined"){
  serverIndex =
    data.timelineIndex %
    (nextItems.length || 1);
}

/* âœ… BOOTSTRAP PLAYBACK */
if(!items.length && nextItems.length){
  index = serverIndex;
  rotate();
}

if(typeof data.timelineIndex !== "undefined"){
  serverIndex =
    data.timelineIndex %
    (nextItems.length || 1);
}

  }catch(err){
    console.log("endpoint retry");
  }
}

/**************** PLAY SLIDE ****************/

function rotate(){

  if(animating) return;
  if(!items.length && !nextItems.length) return;

  /* safe swap */
  if(nextItems.length){
    items = nextItems;
    nextItems = [];
  }

  animating=true;

  const wrapper =
    document.getElementById("text-wrapper");

  const item = items[index % items.length];

  headline.textContent=item.headline||"";
  subline.textContent=item.subline||"";

  /* notify promo screen */
  localStorage.setItem(
    "currentPromo",
    JSON.stringify(item)
  );

  wrapper.className="";
  wrapper.classList.add("slide-in");

  setTimeout(()=>{
    wrapper.classList.remove("slide-in");
    wrapper.classList.add("slide-out");
  },HOLD_DURATION);

  setTimeout(()=>{

  wrapper.classList.remove("slide-out");
  animating=false;

  if(pendingIndex !== null){
    index = pendingIndex;
    pendingIndex = null;
    rotate();
  }

},TOTAL_DURATION);
}

/**************** GLOBAL SYNC CLOCK ****************/

let lastIndex=-1;

setInterval(()=>{

  if(!items.length && !nextItems.length) return;

  if(serverIndex !== index){

    if(animating){
      pendingIndex = serverIndex;
    }else{
      index = serverIndex;
      rotate();
    }
  }

},500);
  
/**************** VIDEO SYNC ****************/

const video = document.getElementById("bgVideo");

let VIDEO_DURATION = 0;

/* get REAL duration */
video.addEventListener("loadedmetadata", () => {
  VIDEO_DURATION = video.duration;
  syncVideo();
});

/* periodic correction */
setInterval(syncVideo, 5000);

function syncVideo(){

  if(!VIDEO_DURATION) return;

  const target =
    (Date.now() / 1000) % VIDEO_DURATION;

  /* only correct large drift */
  if(Math.abs(video.currentTime - target) > 0.5){
    video.currentTime +=
(target - video.currentTime) * 0.25;
  }
}

/**************** START ****************/

loadData();
setInterval(loadData,120000);

</script>

</body>
</html>



